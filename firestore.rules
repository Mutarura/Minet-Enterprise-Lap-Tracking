rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper: Is the user authenticated?
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper: Get user data from Firestore
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Helper: Role checks
    function hasRole(role) {
      return isSignedIn() && getUserData().role == role;
    }

    function isSuperAdmin() {
      return isSignedIn() && (
        request.auth.token.email == 'admin@minet.com' ||
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && getUserData().role == 'superadmin')
      );
    }

    function isAdmin() {
      return hasRole('admin') || isSuperAdmin();
    }

    function isSecurity() {
      return hasRole('security') || isAdmin();
    }

    // Users Collection
    match /users/{userId} {
      allow read: if true; // Public read for username-based email lookup during activation
      
      // Only Superadmin can create users
      allow create: if isSuperAdmin();
      
      // Update restrictions:
      // 1. Superadmin can update anything
      // 2. Users can only update their own activation flags and timestamps during the setup process
      // 3. NO ONE (including Superadmin) can change their own role to prevent elevation or accidental lockout
      allow update: if isSuperAdmin() 
        || (
          isSignedIn() && request.auth.uid == userId 
          && request.resource.data.diff(resource.data).affectedKeys()
              .hasOnly(['mustSetPassword', 'passwordResetRequired', 'lastPasswordChange', 'updatedAt', 'lastLogin', 'tempPasswordHash', 'tempPasswordIssuedAt'])
          && request.resource.data.role == resource.data.role // Cannot change role
          && request.resource.data.isActive == resource.data.isActive // Cannot change status
        );
      
      // Only Superadmin can delete accounts, and NOT their own account
      allow delete: if isSuperAdmin() && request.auth.uid != userId;
    }

    // Employees Collection
    match /employees/{empId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
      allow delete: if isSuperAdmin(); // Explicit delete for seeding
    }

    // Devices Collection
    match /devices/{serial} {
      allow read: if isSignedIn();
      allow write: if isAdmin() || isSecurity();
      allow delete: if isSuperAdmin(); // Explicit delete for seeding
    }

    // Logs, Visitors, Vendors
    match /logs/{id} {
      allow read: if isSignedIn();
      allow create: if isSecurity();
      allow delete: if isSuperAdmin();
    }

    match /visitors/{id} {
      allow read: if isSignedIn();
      allow write: if isSecurity();
    }

    match /vendors/{id} {
      allow read: if isSignedIn();
      allow write: if isSecurity();
    }

    match /vendorVisits/{id} {
      allow read: if isSignedIn();
      allow write: if isSecurity();
    }

    // Audit Logs
    match /auditLogs/{id} {
      allow read: if isSuperAdmin();
      allow create: if true; // Allow creation even during activation (before full sign-in)
      allow update, delete: if false; // Audit logs are immutable
    }
  }
}
